name: Lint OpenAPI Specs

on:
  pull_request:
    paths:
      - '.speakeasy/lint.yaml'
      - 'specs/control-plane-prerelease.yml'
      - 'specs/control-plane.yml'
      - 'specs/control-plane-stage.yml'
      - 'specs/control-plane-dev.yml'
      - 'specs/mgmt-plane-prerelease.yml'
      - 'specs/mgmt-plane.yml'
      - 'overlay/*.yaml'
      - '.github/workflows/*.yml'

jobs:
  lint-specs:
    name: Lint specs
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: ${{ github.head_ref }}

      - name: Install Speakeasy CLI and yq
        run: |
          curl -fsSL https://raw.githubusercontent.com/speakeasy-api/speakeasy/main/install.sh | sh
          mkdir -p $HOME/bin
          wget -qO $HOME/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x $HOME/bin/yq
          echo "$HOME/bin" >> $GITHUB_PATH

      - name: Validate overlay files
        run: |
          for overlay in overlay/*.yaml; do
            if [ -f "$overlay" ]; then
              echo "Validating $overlay..."
              speakeasy overlay validate -o "$overlay"
            fi
          done

      - name: Apply overlays to specs
        run: |
          for overlay in overlay/*.yaml; do
            if [ -f "$overlay" ]; then
              overlay_name=$(basename "$overlay")
              # Extract prefix from overlay file name (e.g., control-plane-overlay.yaml -> control-plane)
              prefix=$(echo "$overlay_name" | sed 's/-overlay\.yaml$//')

              echo "Processing overlay: $overlay_name with prefix: $prefix"

              for spec in specs/${prefix}*.yml; do
                if [ -f "$spec" ]; then
                  echo "Applying $overlay to $spec..."
                  speakeasy overlay apply -s "$spec" -o "$overlay" --out "${spec}-temp.yml"
                  mv "${spec}-temp.yml" "$spec"
                fi
              done
            fi
          done

      - name: Check version format in control-plane.yml
        run: |
          echo "Checking version format in control-plane.yml..."
          
          # Extract version using yq (YAML processor)
          VERSION=$(yq eval '.info.version' specs/control-plane.yml)
          
          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "❌ Error: No version found in control-plane.yml"
            exit 1
          fi
          
          echo "Found version: $VERSION"
          
          # Check if version matches official format: X.Y.Z-<commit-hash>
          # Official format: 4.14.0-837595d5
          # Wrong format: 4.15.0-alpha.1759484970204-f93a1e61
          if echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+-[a-f0-9]{8}$' > /dev/null; then
            echo "✅ Version format is correct (official format): $VERSION"
          elif echo "$VERSION" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+-alpha\.[0-9]+-[a-f0-9]{8}$' > /dev/null; then
            echo "❌ Version format is incorrect (alpha format detected): $VERSION"
            echo "Expected format: X.Y.Z-<8-character-commit-hash>"
            echo "Example: 4.14.0-837595d5"
            exit 1
          else
            echo "❌ Version format is unrecognized: $VERSION"
            echo "Expected format: X.Y.Z-<8-character-commit-hash>"
            echo "Example: 4.14.0-837595d5"
            exit 1
          fi

      - name: Lint control plane spec (prod)
        run: speakeasy lint openapi -r criblSDK -s specs/control-plane.yml --non-interactive

      - name: Lint control plane spec (stage)
        run: speakeasy lint openapi -r criblSDK -s specs/control-plane-stage.yml --non-interactive

      - name: Lint control plane spec (dev)
        run: speakeasy lint openapi -r criblSDK -s specs/control-plane-dev.yml --non-interactive

      - name: Lint control plane spec (prerelease)
        run: speakeasy lint openapi -r criblSDK -s specs/control-plane-prerelease.yml --non-interactive

      - name: Lint management plane spec (prod)
        run: speakeasy lint openapi -r criblSDK -s specs/mgmt-plane.yml --non-interactive

      - name: Lint management plane spec (prerelease)
        run: speakeasy lint openapi -r criblSDK -s specs/mgmt-plane-prerelease.yml --non-interactive

      - name: Commit and push changes
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        working-directory: ${{ github.workspace }}
        run: |
          # Commit and push if there are changes
          if [[ -n $(git status --porcelain) ]]; then
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add specs/*.yml

            echo "Committing overlay changes..."
            git commit -m "Apply overlays to specs [automated]"
            git pull --rebase origin "${{ github.head_ref }}" || true
            git push origin HEAD:"${{ github.head_ref }}"

            # Post PR comment using GitHub REST API
            OVERLAYS=$(ls overlay/*.yaml 2>/dev/null | xargs -n1 basename | tr '\n' ', ' | sed 's/, $//')
            if [ -n "$OVERLAYS" ]; then
              COMMENT_BODY=$(jq -rn --arg b "Applied overlays to specs: ${OVERLAYS}" '{body:$b}')
              curl -sS \
                -H "Authorization: Bearer ${GH_TOKEN}" \
                -H "Accept: application/vnd.github+json" \
                -X POST \
                -d "$COMMENT_BODY" \
                "https://api.github.com/repos/${REPO}/issues/${PR_NUMBER}/comments" >/dev/null
            fi
          else
            echo "No changes to commit"
          fi

  auto-merge:
    name: Auto-merge PR
    needs: lint-specs
    runs-on: ubuntu-latest
    # Only run on pull requests from criblio-ci
    if: ${{ github.event_name == 'pull_request' && github.event.pull_request.user.login == 'criblio-ci' && github.event.pull_request.head.repo.full_name == github.repository }}
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Auto-merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr merge ${{ github.event.pull_request.number }} --squash --delete-branch --auto --repo ${{ github.repository }}
